# 高可用架构设计

> **要实现高可用的系统，不仅仅是在技术层面，还需要一套严谨科学的工程管理**。
> 其中包括但不限于：
> * 软件的设计、编码、测试、上线和软件配置管理的水平
> * 工程师的人员技能水平
> * 运维的管理和技术水平
> * 数据中心的运营管理水平
> * 依赖于第三方服务的管理水平
> 
> 更深层的东西则是 - 对工程这门科学的尊重：
> * 对待技术的态度
> * 一个公司的工程文化
> * 领导者对工程的尊重
> 


- [高可用架构设计](#高可用架构设计)
  - [1 什么是可用性？](#1-什么是可用性)
  - [2 什么会导致了低可用性？](#2-什么会导致了低可用性)
    - [2.1 影响服务不可用的因素分析](#21-影响服务不可用的因素分析)
      - [2.1.1 业界总结的服务不用的因素](#211-业界总结的服务不用的因素)
      - [2.1.2 总结影响服务不可用的因素](#212-总结影响服务不可用的因素)
    - [2.2 业界的故障分级](#22-业界的故障分级)
  - [3 低可用性问题的影响](#3-低可用性问题的影响)
  - [4 如何度量可用性？](#4-如何度量可用性)
  - [5 高可用架构](#5-高可用架构)
    - [5.1 高可用架构目标](#51-高可用架构目标)
    - [5.2 高可用架构实现机制](#52-高可用架构实现机制)
    - [5.3 高可用设计的三种方式](#53-高可用设计的三种方式)
  - [参考资料](#参考资料)

## 1 什么是可用性？
详细内容见 [Concepts-availability](../concepts/availability.md)。
总结下来，系统可用性就是，系统能正常使用的程度，即收到的请求能够正常响应的程度。在不同领域，有的通过时间来评估，有的通过结果来评估。

## 2 什么会导致了低可用性？
### 2.1 影响服务不可用的因素分析
通常有这些原因导致之前运行正常的系统，慢慢变得不可用了：
1. **资源不足(资源耗尽)**：访问用户数量的增加(或者黑客攻击)会导致系统使用的数据量增加，从而可能导致系统资源耗尽，服务处理不过来、运行越来越慢并最终无法响应。
   * 网络带宽不足
   * 计算资源不足
   * 内存资源不足
   * 存储空间不足
   * 磁盘IO不足
   * 处理进程/线程不足
2. **外部依赖问题**：应用程序依赖的外部资源，如基础设施或者第三方依赖服务，这些资源问题越多，导致的可用性问题就会越多。
   * 如果应用程序构建在一个单一的机房，当机房网络故障(网络交换机失效)、断电等、或者自然灾害导致机房损坏，都有可能导致系统可用性问题；
   * 应用程序的服务器宕机、硬盘损坏、网卡损坏，都可能会导致系统可用性问题
   * 如果应用程序构建在某个公有云的某个可用区，当这些云服务故障(也许概率很小)，可能会导致系统可用性问题；
   * 如果应用程序依赖第三方认证系统，当第三方认证系统性能不足或者不可用，会导致当前系统无法进行认证，从而导致系统可用性问题；
   * 如果应用程序依赖第三方数据库/存储，当第三方数据库/存储性能不足或者不可用，会导致应用程序数据无法正常存取，从而导致系统可用性问题；
   * CDN服务挂掉
   * DNS被劫持
   * ...
3. **系统变更(流动行为的增加)**：如新功能发布、新版本发布导致的系统升级和数据升级。当应用程序高速发展时，通常需要更多的开发人员、设计师、测试人员和其他人来开发并维护它。大量的个体共同协作会产生大量的流动行为，包括新功能、变更功能，或者只是一般的维护工作。开发和维护应用程序的人员越多，就会产生越多的流动行为，从而增加了相互之间产生负面作用的可能。
4. **技术债务**：随着应用程序复杂性的增加，通常会导致技术债务(例如，随着应用程序逐渐发展和成熟，对软件未实现的修改和未修复的bug也会逐渐积累)。技术债务会增加可用性问题出现的可能。
   * 服务Bug
   * 系统宕机、系统故障
   * 内存溢出
5. **预期之外的系统压力变化**：随着应用程序被越来越多的人使用，超出了之前系统设计的目标。比如之前的系统设计目标(或者说实际设计能支持的能力)在一万用户访问范围的能力，当应对百万用户访问就可能会产生系统可用性问题。**可能需要对架构、代码和应用程序进行修改以支撑不断增加的压力**。这些改动通常都是在最后一刻被草草实现，缺乏足够的考虑或计划，因此也增加了问题出现的可能性。

#### 2.1.1 业界总结的服务不用的因素
在业界中，会把服务不可用的因素分成两种：一种是有计划的，一种是无计划的。前面列出来的这些基本上属于“无计划的”。

<div align=center><img src="./architecting-for-hign-availability/001.png"></div>
<div align=center><img src="./architecting-for-hign-availability/002.png"></div>

无计划的
* 系统级的故障 –  包括主机、操作系统、中间件、数据库、网络、电源以及外围设备
* 数据和中介的故障 – 包括人员误操作、硬盘故障、数据乱了
* 还有：自然灾害、人为破坏、以及供电问题。

有计划的
* 日常任务：备份，容量规划，用户和安全管理，后台批处理应用
* 运维相关：数据库维护、应用维护、中间件维护、操作系统维护、网络维护
* 升级相关：数据库、应用、中间件、操作系统、网络、包括硬件升级

#### 2.1.2 总结影响服务不可用的因素
**总结一下，从服务的整个生命周期来看，影响服务不可用的因素**：
1. **计划内的(符合预期的不可用)**：
   * 常规维护操作：备份、容量规划、用户和安全管理、后台批处理应用(降低性能)
   * 周期性运维：数据库维护、应用维护、中间件维护、操作系统维护、网络维护
   * 升级：数据库、应用、中间件、操作系统、网络、包括硬件升级
2. **计划外的(不符合预期的不可用)**：
   * 人工误操作
   * 资源不足(资源耗尽)导致的性能问题
   * 外部依赖问题
     * 网络问题
     * 硬件问题
   * 技术债：Bug、不合适的方案、工程管理问题
   * (设计目标)预期之外的系统压力变化

### 2.2 业界的故障分级
亚马逊一般将故障分为4级：
* 1级是全站不可用
* 2级是某功能不可用，且无替代方案
* 3级是某功能不可用，但有替代方案
* 4级是非功能性故障，或者用户不关心的故障

阿里的可用性考核，把故障分为4级：
* 事故级：验证故障，网站整体不可用。权重100。
* A类：网站访问不顺畅或核心功能不可用。权重20。
* B类：非核心功能不可用，或核心功能只有少数客户不可用。权重5。
* C类：其他故障。权重1。

## 3 低可用性问题的影响
可用性问题会增加经营成本，增加用户的成本，降低用户的信任度和忠诚度。

## 4 如何度量可用性？

## 5 高可用架构

### 5.1 高可用架构目标
**高可用架构是一种采用了高可用设计思想的架构，目标是保证服务器硬件故障时依然可用，数据依然可以正确保存并能被访问。**

### 5.2 高可用架构实现机制
**本质**：通过冗余来实现高可用。

**手段**：
* 数据和服务的冗余备份
* 故障失效转移机制(failover)

**设计原则**：
1. 消除单点故障：避免单个节点故障导致系统服务中断。
2. 需要可靠的crossover：在冗余系统中，已能消除服务器单点故障对于系统整体服务的影响，但crossover(如负载均衡器)本身往往更容易形成新的单点故障点，因此在冗余系统中，需要重点保证crossover的高可用性。
3. 需要可靠的故障检测：用户需要看到故障信息，否则用户可能无法知道系统已发生故障。

### 5.3 高可用设计的三种方式
1. 主从方式
   * 非对称方式
   * 主机工作，备机处于监控准备状态
2. 双机互备
   * 互备互援
   * 两台主机同时运行各自的服务工作且相互监测情况
3. 集群
   * 多服务器互备
   * 多台主机一起工作，各自运行一个或几个服务

## 参考资料
1. 《可伸缩架构-云环境下的高可用与风险管理》
2. [酷壳-关于高可用的系统](https://coolshell.cn/articles/17459.html)
3. [Oracle: High Availability Concepts and Best Practices](https://docs.oracle.com/cd/A91202_01/901_doc/rac.901/a89867/pshavdtl.htm)
4. 《阿里云云计算架构师ACE认证培训课程》