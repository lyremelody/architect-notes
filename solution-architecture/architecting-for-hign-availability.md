# 高可用架构设计

> **要实现高可用的系统，不仅仅是在技术层面，还需要一套严谨科学的工程管理**。
> 其中包括但不限于：
> * 软件的设计、编码、测试、上线和软件配置管理的水平
> * 工程师的人员技能水平
> * 运维的管理和技术水平
> * 数据中心的运营管理水平
> * 依赖于第三方服务的管理水平
> 
> 更深层的东西则是 - 对工程这门科学的尊重：
> * 对待技术的态度
> * 一个公司的工程文化
> * 领导者对工程的尊重
> 

- [高可用架构设计](#高可用架构设计)
  - [1 什么是可用性？](#1-什么是可用性)
  - [2 什么会导致了低可用性？](#2-什么会导致了低可用性)
    - [2.1 影响服务不可用的因素分析](#21-影响服务不可用的因素分析)
      - [2.1.1 业界总结的服务不用的因素](#211-业界总结的服务不用的因素)
      - [2.1.2 总结影响服务不可用的因素](#212-总结影响服务不可用的因素)
    - [2.2 业界的故障分级](#22-业界的故障分级)
  - [3 低可用性问题的影响](#3-低可用性问题的影响)
  - [4 如何度量可用性？](#4-如何度量可用性)
    - [4.1 从MTTF、MTTR、MTBF评估](#41-从mttfmttrmtbf评估)
    - [4.2 从RTO、RPO评估](#42-从rtorpo评估)
    - [4.3 总结](#43-总结)
  - [5 高可用技术架构](#5-高可用技术架构)
    - [5.1 高可用技术架构目标](#51-高可用技术架构目标)
    - [5.2 高可用架构实现机制](#52-高可用架构实现机制)
    - [5.3 服务级容错方案](#53-服务级容错方案)
      - [5.3.1 方案一：应对内部故障-隔离](#531-方案一应对内部故障-隔离)
      - [5.3.2 方案二：应对内部故障-限流](#532-方案二应对内部故障-限流)
      - [5.3.3 方案三：应对内部故障-降级](#533-方案三应对内部故障-降级)
      - [5.3.4 方案四：应对内部故障-超时](#534-方案四应对内部故障-超时)
      - [5.3.5 方案五：应对外部故障-超时](#535-方案五应对外部故障-超时)
      - [5.3.6 方案六：应对外部故障-熔断](#536-方案六应对外部故障-熔断)
      - [5.3.7 服务级容错实践原则](#537-服务级容错实践原则)
      - [5.3.8 服务级容错实践 - 设计服务提供容错能力](#538-服务级容错实践---设计服务提供容错能力)
    - [5.4 系统级容错](#54-系统级容错)
      - [5.4.1 常见组件的高可用方案](#541-常见组件的高可用方案)
        - [5.4.1.1 Kubernetes](#5411-kubernetes)
        - [5.4.1.2 MySQL](#5412-mysql)
        - [5.4.1.3 MariaDB](#5413-mariadb)
        - [5.4.1.4 MongoDB](#5414-mongodb)
        - [5.4.1.5 Redis](#5415-redis)
        - [5.4.1.6 Elasticsearch](#5416-elasticsearch)
        - [5.4.1.7 Kafka](#5417-kafka)
    - [5.5 区域级容错](#55-区域级容错)
  - [6 通过提升性能来提升可用性](#6-通过提升性能来提升可用性)
  - [7 通过提升伸缩性来提升可用性](#7-通过提升伸缩性来提升可用性)
  - [8 通过提升可观测性来预防不可用问题](#8-通过提升可观测性来预防不可用问题)
  - [参考资料](#参考资料)

## 1 什么是可用性？
详细内容见 [Concepts-availability](../concepts/availability.md)。
总结下来，系统可用性就是，系统能正常使用的程度，即收到的请求能够正常响应的程度。在不同领域，有的通过时间来评估，有的通过结果来评估。

可用性包括了：
* 成熟性
* 易恢复性
* 容错性
  * 区域级容错
  * 系统级容错
  * 服务级(接口级)容错
  * ...
* ...

## 2 什么会导致了低可用性？
### 2.1 影响服务不可用的因素分析
通常有这些原因导致之前运行正常的系统，慢慢变得不可用了：
1. **资源不足(资源耗尽)**：访问用户数量的增加(或者黑客攻击)会导致系统使用的数据量增加，从而可能导致系统资源耗尽，服务处理不过来、运行越来越慢并最终无法响应。
   * 网络带宽不足
   * 计算资源不足
   * 内存资源不足
   * 存储空间不足
   * 磁盘IO不足
   * 处理进程/线程不足
2. **外部依赖问题**：应用程序依赖的外部资源，如基础设施或者第三方依赖服务，这些资源问题越多，导致的可用性问题就会越多。
   * 如果应用程序构建在一个单一的机房，当机房网络故障(网络交换机失效)、断电等、或者自然灾害导致机房损坏，都有可能导致系统可用性问题；
   * 应用程序的服务器宕机、硬盘损坏、网卡损坏，都可能会导致系统可用性问题
   * 如果应用程序构建在某个公有云的某个可用区，当这些云服务故障(也许概率很小)，可能会导致系统可用性问题；
   * 如果应用程序依赖第三方认证系统，当第三方认证系统性能不足或者不可用，会导致当前系统无法进行认证，从而导致系统可用性问题；
   * 如果应用程序依赖第三方数据库/存储，当第三方数据库/存储性能不足或者不可用，会导致应用程序数据无法正常存取，从而导致系统可用性问题；
   * CDN服务挂掉
   * DNS被劫持
   * ...
3. **系统变更(流动行为的增加)**：如新功能发布、新版本发布导致的系统升级和数据升级。当应用程序高速发展时，通常需要更多的开发人员、设计师、测试人员和其他人来开发并维护它。大量的个体共同协作会产生大量的流动行为，包括新功能、变更功能，或者只是一般的维护工作。开发和维护应用程序的人员越多，就会产生越多的流动行为，从而增加了相互之间产生负面作用的可能。
4. **技术债务**：随着应用程序复杂性的增加，通常会导致技术债务(例如，随着应用程序逐渐发展和成熟，对软件未实现的修改和未修复的bug也会逐渐积累)。技术债务会增加可用性问题出现的可能。
   * 服务Bug
   * 系统宕机、系统故障
   * 内存溢出
5. **预期之外的系统压力变化**：随着应用程序被越来越多的人使用，超出了之前系统设计的目标。比如之前的系统设计目标(或者说实际设计能支持的能力)在一万用户访问范围的能力，当应对百万用户访问就可能会产生系统可用性问题。**可能需要对架构、代码和应用程序进行修改以支撑不断增加的压力**。这些改动通常都是在最后一刻被草草实现，缺乏足够的考虑或计划，因此也增加了问题出现的可能性。

#### 2.1.1 业界总结的服务不用的因素
在业界中，会把服务不可用的因素分成两种：一种是有计划的，一种是无计划的。前面列出来的这些基本上属于“无计划的”。

<div align=center><img src="./architecting-for-hign-availability/001.png"></div>
<div align=center><img src="./architecting-for-hign-availability/002.png"></div>

无计划的
* 系统级的故障 –  包括主机、操作系统、中间件、数据库、网络、电源以及外围设备
* 数据和中介的故障 – 包括人员误操作、硬盘故障、数据乱了
* 还有：自然灾害、人为破坏、以及供电问题。

有计划的
* 日常任务：备份，容量规划，用户和安全管理，后台批处理应用
* 运维相关：数据库维护、应用维护、中间件维护、操作系统维护、网络维护
* 升级相关：数据库、应用、中间件、操作系统、网络、包括硬件升级

#### 2.1.2 总结影响服务不可用的因素
**总结一下，从服务的整个生命周期来看，影响服务不可用的因素**：
1. **计划内的(符合预期的不可用)**：
   * 常规维护操作：备份、容量规划、用户和安全管理、后台批处理应用(降低性能)
   * 周期性运维：数据库维护、应用维护、中间件维护、操作系统维护、网络维护
   * 升级：数据库、应用、中间件、操作系统、网络、包括硬件升级
2. **计划外的(不符合预期的不可用)**：
   * 人工误操作
   * 资源不足(资源耗尽)导致的性能问题
   * 外部依赖问题
     * 网络问题
     * 硬件问题
   * 技术债：Bug、不合适的方案、工程管理问题
   * (设计目标)预期之外的系统压力变化

### 2.2 业界的故障分级
亚马逊一般将故障分为4级：
* 1级是全站不可用
* 2级是某功能不可用，且无替代方案
* 3级是某功能不可用，但有替代方案
* 4级是非功能性故障，或者用户不关心的故障

阿里的可用性考核，把故障分为4级：
* 事故级：严重故障，网站整体不可用。权重100。
* A类：网站访问不顺畅或核心功能不可用。权重20。
* B类：非核心功能不可用，或核心功能只有少数客户不可用。权重5。
* C类：其他故障。权重1。

## 3 低可用性问题的影响
可用性问题会增加经营成本，增加用户的成本，降低用户的信任度和忠诚度。

## 4 如何度量可用性？
### 4.1 从MTTF、MTTR、MTBF评估
业界一般使用 MTTF、MTTR、MTBF 这3个指标来计算系统可用性：
* MTTF：全称 Mean Time To Failure，即平均无故障时间。
* MTTR：全称 Mean Time To Repair，即平均修复时间。
* MTBF：全称 Mean Time Between Failure，即平均故障间隔时间。

<div align=center><img src="./architecting-for-hign-availability/MTTF-MTTR-MTBF.png"></div>

各时间段说明：
* t1时间段，出现问题到发现问题
* t2时间段，分析、诊断问题
* t3时间段，修复问题(修改、验证、上线)
* t4时间段，系统正常运行

定义 n 表示故障数。上图发生了两次故障，n=2
> MTTF = (∑t4) / n
> MTTR = (∑(t1+t1+t3))/ n
> MTBF = MTTF + MTTR
> 
> 可用性 = MTTF / MTBF * 100%

但是，并不是“可用性”的值越高，系统可用性就越高，举个例子：
* A系统，MTBF=2h，MTTR=5s，即可以稳定运行2小时，然后挂掉，5秒钟之后又恢复了，通过公式计算Availability=0.9999768，约等于5个9。
* B系统，MTBF=30day，MTTR=1h，即可以稳定运行30天，然后挂掉，1小时之后恢复，通过公式计算Availability=0.9986130，约等于4个9。

虽然A系统计算出来的可用性高于B系统，但是A系统发生故障的频率远远高于B系统（即A系统的MTTF远远低于B系统），用户体验非常差，故可用性除了要关注 Availability 的值，还需要关注 MTTF。

故系统可用性评价标准：
* MTTF：越大越好
* 可用性：越高越好
### 4.2 从RTO、RPO评估
**RPO(Recovery Point Objective)** 即数据恢复点目标，主要指的是业务系统所能容忍的数据丢失量。
**RTO(Recovery Time Objective)** 即恢复时间目标，主要指的是所能容忍的业务停止服务的最长时间，也就是从灾难发生到业务系统恢复服务功能所需要的最短时间周期。

<div align=center><img src="./architecting-for-hign-availability/003.png"></div>

详见 [RPO & RTO](./concepts/RPO-RTO.md) 。

### 4.3 总结
RTO 和 MTTR 非常相似，都是描述系统的恢复时间。
主要区别在于：
* MTTR 是一段时间内，多个影响可用性事件恢复时间的平均值；
* RTO 則是单一影响可用性事件允许的目标最大恢复时间。
 
**对于系统设计者来说，MTTR 作为一个多次平均值，不好验证，甚至无法验证。单次最大值 RTO 更适合作为明确的目标。**

## 5 高可用技术架构
### 5.1 高可用技术架构目标
**高可用架构是一种采用了高可用设计思想的架构，目标是保证服务器硬件故障时依然可用，数据依然可以正确保存并能被访问。**

### 5.2 高可用架构实现机制
**本质**：通过冗余来实现高可用。

**设计原则**：
1. 多可用区设计：尽最大可能避免架构中的单点故障。
2. 自我修复设计：内建容错及检查能力，应用能够在部分组件失效时自我修复继续工作。
3. 假定失效设计：假定任何环节都会出问题，然后推倒设计。
4. 自动扩展设计：不进行设计调整，就能满足业务量增长。
5. 松耦合设计：耦合度越小，扩展性越好，容错能力越强。

**手段**：
* 服务级容错
  * 服务实现超时、隔离、限流、熔断、降级
* 系统级容错
  * 故障失效转移机制(failover)
  * 负载均衡
  * 分布式技术
* 区域级容错
  * 异地多活、容灾、备份恢复

### 5.3 服务级容错方案
#### 5.3.1 方案一：应对内部故障-隔离
将系统按照一定的规则划分成若干服务模块(接口集)或者说微服务，各个模块之间相对独立。当故障发生时，能将问题和影响隔离在某个模块内部，而不扩散风险，不涉及其他模块。
* 例如1：线程池隔离，设计服务对每个功能(服务的调用)提供一个线程池。
* 例如2：拆分微服务，将在不同领域的业务拆分成多个服务。

TODO：图

#### 5.3.2 方案二：应对内部故障-限流
从用户访问压力角度考虑应对故障：对服务的输入和输出进行限制，以达到保护系统的目的。基于请求限流/基于资源限流：一旦达到限制的阈值，就需要限制流量并采取少量措施以完成限制流量的目的。
* 例如：对某服务设置线程数 10 个，满了就拒绝请求而不是阻塞或者设置90%CPU，超过就不接收请求

TODO：图

#### 5.3.3 方案三：应对内部故障-降级
从功能优先级的角度考虑应对故障：将某些业务或接口的功能降低，只提供部分功能。
* 例如1：人工配置某服务直接返回认证失败，不提供第三方认证
* 例如2：实现服务功能管理，配置化管理sharemgnt当前提供的服务能力

TODO：图

#### 5.3.4 方案四：应对内部故障-超时
外部服务访问自身：在被上游服务调用时，对外部已断开连接或中断请求，应丢弃对应请求。
* 例如：设计服务进行业务处理前，对连接和请求状态进行检查。

TODO：图

#### 5.3.5 方案五：应对外部故障-超时
访问外部服务：在调用下游服务时，设置一个最大响应时间，如果超过了这个时间，下游未作出反应，就断开请求释放掉线程。
* 例如：设计服务每个请求设置超时时间 5 秒。

TODO：图

#### 5.3.6 方案六：应对外部故障-熔断
为了保护系统整体可用性应对外部系统故障：当下游服务因为访问压力过大而响应变慢或失败时，可以暂时切断对下游服务的调用。
* 例如：设计服务统计访问第三方某个接口的结果，超过10次失败，就30s内直接返回503

TODO：图

#### 5.3.7 服务级容错实践原则
**原则1**：服务对于网络接口的调用必须提供超时机制，并且超时参数可配置。

**原则2**：服务需要提供线程池隔离能力。不同功能模块需要使用不同的线程池，并且线程池参数可配置。

**原则3**：服务需要实现限流机制。需要提供资源配置(如最大连接数/CPU/内存等)，资源(如连接数)超了需要立即拒绝请求，并且限流参数可配置。

**原则4**：服务需要提供熔断机制。当下游服务能力不足时(可以通过监测下游接口失败次数)，能够切断对于下游服务的调用，直接基于下游服务错误进行处理，并且熔断参数可配置。

#### 5.3.8 服务级容错实践 - 设计服务提供容错能力
1. **实现超时机制**：
   * 实现超时策略配置化；
   * HTTP Requests 加超时参数；
   * RPC Requests 加超时参数。
2. **实现隔离机制**：
   * 实现线程池策略配置化；
   * 每个服务进程开多个线程池，每个模块一个(如果对于业务全景做了分析和建模，可以考虑基于功能拆分服务) 。
3. **实现限流机制**：
   * 实现限流策略配置化；
   * 设置连接池，超过连接池，直接返回 503 拒绝；
   * 设置资源标准，超过资源使用，直接返回 503 拒绝。
4. **实现熔断机制**：
   * 实现熔断策略配置化；
   * 对每个接口的调用实现一个计数器，失败+1，成功清零；
   * 当计数器超过配置参数，所有调用直接返回 503，定时一段时间清空计算器。

### 5.4 系统级容错

**分布式服务高可用设计的三种方式**：
1. **主从方式**：主机工作，备机处于监控准备状态；当主机宕机时，备机接管主机的一切工作，待主机恢复正常后，按使用者的设定以自动或手动方式将服务切换到主机上运行，数据的一致性通过共享存储系统解决。
2. **双机互备**：两台主机甚至多台主机同时运行各自的服务工作且相互监测情况，当任何一台主机宕机时，另一台主机立即接管它的一切工作，保证实时切换以及应用服务系统的关键数据存放在共享存储系统中。
3. **集群**：多台主机一起工作，各自运行一个或几个服务，各个子集群相对独立，共同支撑复杂的整体业务。这种架构逻辑层次清晰，扩展相对容易，当然成本相对较高。

#### 5.4.1 常见组件的高可用方案
##### 5.4.1.1 Kubernetes
##### 5.4.1.2 MySQL
##### 5.4.1.3 MariaDB
##### 5.4.1.4 MongoDB
##### 5.4.1.5 Redis
##### 5.4.1.6 Elasticsearch
##### 5.4.1.7 Kafka

### 5.5 区域级容错

## 6 通过提升性能来提升可用性
## 7 通过提升伸缩性来提升可用性
## 8 通过提升可观测性来预防不可用问题

## 参考资料
1. 《可伸缩架构-云环境下的高可用与风险管理》
2. [酷壳-关于高可用的系统](https://coolshell.cn/articles/17459.html)
3. [Oracle: High Availability Concepts and Best Practices](https://docs.oracle.com/cd/A91202_01/901_doc/rac.901/a89867/pshavdtl.htm)
4. 《阿里云云计算架构师ACE认证培训课程》
5. [5分钟搞懂 Availability/Durability/MTTR/MTBF/RTO/RPO](https://zhuanlan.zhihu.com/p/569502612)